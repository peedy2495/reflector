#!/bin/bash

function yum_mirror() {
    if [[ ${enabled,,} =~ ^(1|yes|true)$ ]]; then
        if [[ ${pull,,} =~ ^(rsync)$ ]]; then
            yum_rsync
        elif [[ ${pull,,} =~ ^(web|wget|http|https|ftp|sftp)$ ]]; then
            yum_wget
        fi
    fi
}

function create_yum-repofile() {
    if [ ! -d "$path" ]; then
        mkdir -p $path
    fi
    repofile="$path/${tag}.repo"
    echo "### auto generated file from upfRepos.sh as of $(date)" >$repofile
    echo "[${tag}]" >>$repofile
    echo "name=$descr" >>$repofile
    echo "baseurl=$repourl/${destination[$i]}" >>$repofile
    echo "enabled=1" >>$repofile
    echo "metadata_expire=7d" >>$repofile
    echo "repo_gpgcheck=0" >>$repofile
    echo "type=rpm" >>$repofile
    echo "gpgcheck=0" >>$repofile
    echo "skip_if_unavailable=False" >>$repofile
}

function yum_rsync() {
    echo "syncing from ${source} to ${basedest}${destination} ..."
    if [ ! -d "${basedest}${destination}" ]; then
        mkdir -p ${basedest}${destination}
    fi
    rsync -avrt "rsync://${source}" "${basedest}${destination}" --delete-after
    if [[ "${tag}" != "skip" ]]; then
        path="${basedest}.repofiles/${yumdir}"
        create_yum-repofile
    fi
}

function yum_wget() {
    echo "syncing from ${source} to ${basedest}${destination} ..."
    wget \
        --no-http-keep-alive\
        --no-cache\
        --no-cookies\
        -r\
        -np\
        -nc\
        -c\
        -R html -R "robots.txt*"\
        ${options}\
        ${source}\
        -P ${basedest}
    if [[ "${tag}" != "skip" ]]; then
        dest="${source}"
        dest="${dest#http://}"
        dest="${dest#https://}"
        destination="$dest"
        path="${basedest}.repofiles/${tag}"
        create_yum-repofile
    fi
}

function yum_gpgkeys() {
    for key in "${keys[@]}"; do
        ## Remove protocol part of url  ##
        host="${key#http://}"
        host="${host#https://}"
        host="${host#ftp://}"
        host="${host#scp://}"
        host="${host#scp://}"
        host="${host#sftp://}"
        ## Remove username and/or username:password part of URL  ##
        host="${host#*:*@}"
        host="${host#*@}"
        ## Remove rest of urls ##
        host=${host%%/*}
 
        wget $key -O "${basedest}/.keys/$host.key"
    done
}